<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="iso-8859-1">
<title>Developer Assignment Toolbar</title>
<style>
  body {
    margin: 0;
    background: #FFFFFF url('Images/NAV1.JPG');
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
  }
  table { border-collapse: collapse; width: 100%; }
  td { padding: 0 2px; white-space: nowrap; vertical-align: middle; }
  button { padding: 2px 5px; font-size: 12px; height: 22px; line-height: 1; margin-right: 2px; }
  select { font-size: 12px; height: 22px; margin-left: 2px; }
  font { color: white; }
</style>
</head>
<body>

<form id="frmDeveloperAssignmentToolBar">
  <table width="100%" cellspacing="0" cellpadding="0">
    <tr><td align="center"><font size="4">Developer Assignment</font></td></tr>
  </table>

  <table width="100%" cellspacing="2" cellpadding="0">
    <tr>
      <td align="left" nowrap>
        <button type="button" id="btnUpdate">Update</button>
        <button type="button" id="btnQuery">Query</button>
        <span style="color:white; margin-left:10px;font-size:16px">Manager:
          <select id="cmbProjectManagerID"></select>
        </span>
        <span style="color:white; margin-left:10px;font-size:16px">Module:
          <select id="cmbModuleNo"></select>
        </span>
        <span style="color:white; margin-left:10px;font-size:16px">Developer:
          <select id="cmbDeveloperID"></select>
        </span>
      </td>
    </tr>
  </table>
</form>

<script>
async function loadToolbarData() {
  try {
    const res = await fetch("/api/DeveloperAssignmentToolbar");
    const data = await res.json();

    const currentUserID = data.currentUserID;

    // Manager dropdown
    const cmbManager = document.getElementById("cmbProjectManagerID");
    cmbManager.innerHTML = "<option value='All'>All</option>";
    data.developers
      .filter(d => d.BuildRole?.trim().toLowerCase() === "project manager")
      .forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.DeveloperID;
        opt.text = d.DeveloperName;
        if(d.DeveloperID === currentUserID) opt.selected = true;
        cmbManager.appendChild(opt);
      });

    // Module dropdown
    const cmbModule = document.getElementById("cmbModuleNo");
    cmbModule.innerHTML = "<option value='0' selected>All</option>";
    data.modules.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.ModuleNo;
      opt.text = m.ModuleID;
      cmbModule.appendChild(opt);
    });

    // Developer dropdown
    const cmbDeveloper = document.getElementById("cmbDeveloperID");
    cmbDeveloper.innerHTML = "<option value='All' selected>All</option>";
    data.developers.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.DeveloperID;
      opt.text = d.DeveloperName;
      cmbDeveloper.appendChild(opt);
    });

  } catch(err) {
    console.error("Failed to load toolbar data", err);
  }
}

// Send filters to grid iframe
function sendFilters(mode) {
  const filters = {
    FormMode: mode,
    QryProjectManagerID: document.getElementById("cmbProjectManagerID").value,
    QryModuleNo: document.getElementById("cmbModuleNo").value,
    QryDeveloperID: document.getElementById("cmbDeveloperID").value
  };

  const gridIframe = parent.document.getElementById("grid");
  if(gridIframe && gridIframe.contentWindow) {
    gridIframe.contentWindow.postMessage(filters, "*");
  }
}

document.getElementById("btnQuery").addEventListener("click", () => sendFilters("Query"));
document.getElementById("btnUpdate").addEventListener("click", () => sendFilters("Update"));

loadToolbarData();
</script>

</body>
</html>
